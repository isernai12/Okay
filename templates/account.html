{% extends "layout.html" %}
{% block content %}
  <h1>Account</h1>

  <div class="row" style="margin-bottom:12px;">
    <a class="btn" href="{{ url_for('dashboard') }}"><i class="ri-arrow-left-line"></i> Back</a>
    <a class="btn" href="{{ url_for('view_mailbox', mailbox_id=account.mailbox_id) }}"><i class="ri-inbox-line"></i> View Inbox</a>
    <button class="btn btn-danger" type="button" data-confirm="delete-account"><i class="ri-delete-bin-6-line"></i> Delete</button>
  </div>

  <div class="card">
    <div class="kv">
      <div class="k">Gmail</div>
      <div class="v">
        <div class="copyline">
          <span class="mono" id="gmail">{{ account.gmail }}</span>
          <button class="btn btn-sm" type="button" onclick="copyText('gmail')"><i class="ri-file-copy-line"></i> Copy</button>
        </div>
      </div>

      <div class="k">Generated Password</div>
      <div class="v">
        <div class="copyline">
          <span class="mono" id="genpass">{{ account.generated_password }}</span>
          <button class="btn btn-sm" type="button" onclick="copyText('genpass')"><i class="ri-file-copy-line"></i> Copy</button>
        </div>
        <div class="muted">This password is generated once and will not change.</div>
      </div>

      <div class="k">Generated Email</div>
      <div class="v">
        <div class="copyline">
          <span class="mono" id="genemail">{{ account.email }}</span>
          <button class="btn btn-sm" type="button" onclick="copyText('genemail')"><i class="ri-file-copy-line"></i> Copy</button>
        </div>
      </div>

      <div class="k">Authenticator Code</div>
      <div class="v">
        {% if account.totp_secret %}
          <div class="copyline">
            <span class="mono bigcode" id="totpcode">{{ code }}</span>
            <button class="btn btn-sm" type="button" onclick="copyText('totpcode')"><i class="ri-file-copy-line"></i> Copy</button>
          </div>
          <div class="muted">Updates in real-time. Remaining: <span id="remain">{{ remaining }}</span>s</div>
        {% else %}
          <div class="muted">Not set yet. Upload QR or paste secret below.</div>
        {% endif %}
      </div>

      <div class="k">Authenticator Info</div>
      <div class="v">
        <div class="mono">issuer: {{ account.totp_issuer or "-" }}</div>
        <div class="mono">label: {{ account.totp_label or "-" }}</div>
        <div class="copyline">
          <span class="mono" id="totpsecret">secret: {{ account.totp_secret or "-" }}</span>
          <button class="btn btn-sm" type="button" onclick="copyText('totpsecret')"><i class="ri-file-copy-line"></i> Copy</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <h2 style="margin:0 0 10px 0; font-size:16px;">Set Authenticator (QR or Secret)</h2>

    <form method="post" action="{{ url_for('account_set_authenticator', account_id=account.id) }}" enctype="multipart/form-data">
      <label>Upload QR image (screenshot/photo)</label>
      <input class="input" type="file" name="qr_image" accept="image/*" />

      <label>OR paste secret (Base32)</label>
      <input class="input" type="text" name="secret" placeholder="JBSWY3DPEHPK3PXP" />

      <button class="btn btn-primary" type="submit"><i class="ri-shield-keyhole-line"></i> Save authenticator</button>
    </form>

    <p class="muted" style="margin-top:10px;">
      If the image contains many objects, the system will try to detect only the QR code.
    </p>

    <div class="divider"></div>
    <form method="post" action="{{ url_for('account_delete_authenticator', account_id=account.id) }}" id="delete-auth-form">
      <button class="btn btn-danger" type="button" data-confirm="delete-auth"><i class="ri-delete-bin-line"></i> Remove authenticator</button>
    </form>
  </div>

  <form method="post" action="{{ url_for('account_delete', account_id=account.id) }}" id="delete-account-form"></form>

  <div class="modal" id="confirm-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-icon"><i class="ri-alert-line"></i></div>
      <h3 id="modal-title">Confirm delete</h3>
      <p id="modal-message" class="muted">Are you sure? This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn" type="button" data-close-modal>Cancel</button>
        <button class="btn btn-danger" type="button" id="modal-confirm">Delete</button>
      </div>
    </div>
  </div>

  <script>
    async function refreshTOTP() {
      try {
        const res = await fetch("{{ url_for('account_totp_json', account_id=account.id) }}", { cache: "no-store" });
        const data = await res.json();
        if (!data.ok) return;

        if (!data.enabled) return;

        const codeEl = document.getElementById("totpcode");
        const remEl = document.getElementById("remain");
        if (codeEl && data.code) codeEl.textContent = data.code;
        if (remEl && typeof data.remaining === "number") remEl.textContent = data.remaining;
      } catch (e) {}
    }

    function copyText(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const raw = el.textContent || "";
      const text = id === "totpsecret" ? raw.replace("secret:", "").trim() : raw.trim();
      navigator.clipboard.writeText(text);
    }

    // realtime updates
    setInterval(refreshTOTP, 1000);

    const modal = document.getElementById("confirm-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalMessage = document.getElementById("modal-message");
    const modalConfirm = document.getElementById("modal-confirm");
    const closeModalButtons = modal.querySelectorAll("[data-close-modal]");
    let submitTarget = null;

    function openModal({ title, message, submitId }) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      submitTarget = document.getElementById(submitId);
      modal.setAttribute("aria-hidden", "false");
      modal.classList.add("open");
    }

    function closeModal() {
      modal.setAttribute("aria-hidden", "true");
      modal.classList.remove("open");
      submitTarget = null;
    }

    document.querySelectorAll("[data-confirm]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const type = btn.getAttribute("data-confirm");
        if (type === "delete-auth") {
          openModal({
            title: "Remove authenticator?",
            message: "This will delete the saved authenticator from the server. You can add a new one anytime.",
            submitId: "delete-auth-form",
          });
        } else {
          openModal({
            title: "Delete account?",
            message: "This will delete the account, mailbox, and all messages.",
            submitId: "delete-account-form",
          });
        }
      });
    });

    modalConfirm.addEventListener("click", () => {
      if (submitTarget) {
        submitTarget.submit();
      }
    });

    closeModalButtons.forEach((btn) => btn.addEventListener("click", closeModal));
    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  </script>
{% endblock %}
